name: Reviewdog

on:
  pull_request:

jobs:
  reviewdog-dotnet:
    permissions:
      checks: write
      contents: read
      pull-requests: write
    name: reviewdog (.NET)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup reviewdog
        uses: reviewdog/action-setup@d8edfce3dd5e1ec6978745e801f9c50b5ef80252 # v1.4.0
        with:
          reviewdog_version: latest

      - name: Restore dependencies
        run: dotnet restore

      - name: Run dotnet format check
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic . 2>&1 | reviewdog -efm="%f(%l,%c): %m" -name="dotnet-format" -reporter=github-pr-review -fail-on-error=false || true

      - name: Run dotnet build (warnings)
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet build --no-restore 2>&1 | reviewdog -f=msbuild -name="dotnet-build-warnings" -reporter=github-pr-review -level=warning -filter-mode=file -fail-on-error=false || true

      - name: Run dotnet build (errors)
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet build --no-restore 2>&1 | reviewdog -f=msbuild -name="dotnet-build-errors" -reporter=github-pr-review -level=error -filter-mode=file -fail-on-error=false || true

      - name: Run tests with coverage
        run: |
          dotnet test --collect:"XPlat Code Coverage" --results-directory ./coverage --verbosity normal

      - name: Report test coverage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import xml.etree.ElementTree as ET
          import glob
          import urllib.request
          import urllib.error
          
          # Find coverage XML file
          coverage_files = glob.glob('./coverage/**/coverage.cobertura.xml', recursive=True)
          
          if not coverage_files:
              print("No coverage file found")
              exit(0)
          
          coverage_file = coverage_files[0]
          
          # Parse coverage XML
          tree = ET.parse(coverage_file)
          root = tree.getroot()
          
          line_rate = float(root.get('line-rate', 0))
          branch_rate = float(root.get('branch-rate', 0))
          
          line_coverage = line_rate * 100
          branch_coverage = branch_rate * 100
          
          # Create coverage comment
          coverage_comment = f"""## ðŸ“Š Test Coverage Report
          
          | Metric | Coverage |
          |--------|----------|
          | **Line Coverage** | {line_coverage:.2f}% |
          | **Branch Coverage** | {branch_coverage:.2f}% |
          
          _Generated by reviewdog pipeline_"""
          
          # Post comment to PR using GitHub API
          repo = os.environ.get('GITHUB_REPOSITORY')
          pr_number = os.environ.get('PR_NUMBER')
          
          # Try to get PR number from event file if not in env
          if not pr_number:
              event_path = os.environ.get('GITHUB_EVENT_PATH')
              if event_path and os.path.exists(event_path):
                  with open(event_path, 'r') as f:
                      event_data = json.load(f)
                      pr_number = event_data.get('pull_request', {}).get('number')
          
          if not pr_number:
              print("Could not determine PR number - skipping coverage comment")
              exit(0)
          
          url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          headers = {
              "Accept": "application/vnd.github+json",
              "Authorization": f"Bearer {os.environ.get('GITHUB_TOKEN')}",
              "X-GitHub-Api-Version": "2022-11-28",
              "Content-Type": "application/json"
          }
          data = json.dumps({"body": coverage_comment}).encode('utf-8')
          
          try:
              req = urllib.request.Request(url, data=data, headers=headers, method='POST')
              with urllib.request.urlopen(req) as response:
                  print("Coverage comment posted successfully")
          except urllib.error.HTTPError as e:
              print(f"Failed to post coverage comment: {e.code} - {e.reason}")
              if e.fp:
                  print(e.fp.read().decode())
          except Exception as e:
              print(f"Error posting coverage comment: {e}")
          EOF
